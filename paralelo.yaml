blueprint:
  name: Paralelo Virtual (Ultra Rápido)
  description: Sincroniza switches/lights instantaneamente com proteção anti-loop e performance otimizada
  domain: automation
  input:
    entrada_switchs:
      name: Pontos de Iluminação
      description: Selecione os dispositivos para sincronizar
      selector:
        entity:
          domain:
            - switch
            - light
          multiple: true
    
    delay_ms:
      name: Delay de proteção (ms)
      description: Tempo mínimo entre execuções para evitar loops (0 = desativado)
      default: 50
      selector:
        number:
          min: 0
          max: 500
          step: 10
          unit_of_measurement: ms
          mode: slider

mode: single
max_exceeded: silent

trigger:
  - platform: state
    entity_id: !input entrada_switchs
    # Remove especificação de 'to' para capturar todas as mudanças

condition:
  # Condições combinadas para máxima eficiência
  - condition: and
    conditions:
      # Filtra apenas mudanças para on/off (ignora unavailable, unknown, etc)
      - condition: template
        value_template: >
          {{ trigger.to_state.state in ['on', 'off'] and
             trigger.from_state.state in ['on', 'off', 'unavailable', 'unknown', none] }}
      
      # Evita loops - verifica se não foi a própria automação
      - condition: template
        value_template: >
          {{ trigger.to_state.context.id != this.context.id
             and trigger.to_state.context.parent_id != this.context.id }}
      
      # Garante mudança real de estado
      - condition: template
        value_template: >
          {{ trigger.to_state.state != trigger.from_state.state }}
      
      # Proteção contra execuções muito rápidas (anti-bounce)
      - condition: template
        value_template: >
          {% set last_triggered = state_attr(this.entity_id, 'last_triggered') %}
          {% set delay = delay_ms | default(50) | int %}
          {{ last_triggered is none or 
             (now() - last_triggered).total_seconds() * 1000 > delay }}

variables:
  entidades: !input entrada_switchs
  delay_ms: !input delay_ms
  # Pré-calcula lista de entidades para sincronizar
  outros: >
    {{ entidades | reject('equalto', trigger.entity_id) | list }}
  # Captura estado alvo para garantir consistência
  estado_alvo: "{{ trigger.to_state.state }}"

action:
  # Delay mínimo opcional para proteção extra
  - choose:
      - conditions: "{{ delay_ms | int > 0 }}"
        sequence:
          - delay:
              milliseconds: "{{ delay_ms | int }}"
    default: []
  
  # Execução direta sem choose para máxima velocidade
  - service: "homeassistant.turn_{{ estado_alvo }}"
    data:
      entity_id: "{{ outros }}"
    continue_on_error: true
  
  # Log opcional para debug (remover em produção)
  # - service: system_log.write
  #   data:
  #     message: >
  #       Paralelo Virtual: {{ trigger.entity_id }} -> {{ estado_alvo }}
  #       Sincronizando: {{ outros | length }} dispositivos
  #     level: debug
